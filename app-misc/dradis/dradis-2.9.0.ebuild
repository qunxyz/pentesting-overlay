# Copyright 1999-2010 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $

EAPI="5"

inherit eutils versionator systemd

DESCRIPTION="A framework for effective information sharing"
HOMEPAGE="http://dradisframework.org/"
SRC_URI="https://github.com/dradis/dradis-legacy/archive/v${PV}.tar.gz -> ${PF}.tar.gz 
		 https://raw.github.com/dradis/meta/master/verify.sh 
		 https://raw.github.com/dradis/meta/master/reset.sh 
		 https://raw.github.com/dradis/meta/master/start.sh"

LICENSE="GPL-2"
SLOT="0"
KEYWORDS="~x86 ~amd64"
IUSE="mysql systemd"

DEPEND=">=dev-ruby/rake-3.2.0
		 dev-ruby/sqlite3
		 dev-ruby/rubygems
		 dev-ruby/uglifier
		 mysql? ( dev-ruby/mysql-ruby )
		 systemd? ( sys-apps/systemd )"
RDEPEND="${DEPEND}"

S="${WORKDIR}/dradis-legacy-${PV}"

src_install() {
	#insinto /etc/dradis
	#newins "${FILESDIR}/dradis.conf" dradis.conf
	insinto /usr/share/$PN
	doins  -r * || die "install failed"
	rm Gemfile.lock
	#newbin script/bj $PN
	newinitd "${FILESDIR}"/dradis.initd $PN
	newconfd "${FILESDIR}"/dradis.confd $PN
	insinto /usr/lib/systemd/system
	newins "${FILESDIR}/dradis-${PV}.service" dradis.service
}

pkg_postinst() {
	einfo "Setting up sqlite database."
	cd /usr/share/$PN/
	chmod +x *.sh
	./verify.sh
	./reset.sh
	cd server/
	RAILS_ENV=development bundle exec rake assets:precompile
	if use mysql; then
		einfo "If you want to use a MySQL database check the dradis\
		documentation: http://dradisframework.org/configure.html\#configure"
	fi
}
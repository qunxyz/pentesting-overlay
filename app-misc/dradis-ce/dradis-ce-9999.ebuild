# Copyright 1999-2010 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $

EAPI="5"

inherit eutils versionator systemd git-2

DESCRIPTION="A framework for effective information sharing"
HOMEPAGE="http://dradisframework.org/"
EGIT_REPO_URI="git://github.com/dradis/dradis-ce.git"
SRC_URI=""

LICENSE="GPL-2"
SLOT="0"
KEYWORDS="~x86 ~amd64"
IUSE="mysql systemd"

DEPEND="app-misc/dradis-plugins
		app-misc/dradis-projects
		 dev-ruby/rake
		 dev-ruby/sqlite3
		 dev-ruby/rubygems
		 dev-ruby/uglifier
		 mysql? ( dev-ruby/mysql-ruby )
		 systemd? ( sys-apps/systemd )"
RDEPEND="${DEPEND}"

src_install() {
	#insinto /etc/dradis
	#newins "${FILESDIR}/dradis.conf" dradis.conf
	insinto /usr/share/$PN
	cp  -ar * . || die "install failed"
	#newbin script/bj $PN
	newinitd "${FILESDIR}"/dradis.initd $PN
	newconfd "${FILESDIR}"/dradis.confd $PN
	systemd_dounit "${FILESDIR}/dradis.service"
}

pkg_postinst() {
	einfo "Setting up sqlite database."
	cd /usr/share/$PN/
	bundle install
	ruby bin/rake db:migrate RAILS_ENV=development
	ruby bin/setup RAILS_ENV=development
	RAILS_ENV=development bundle exec thor dradis:reset
	RAILS_ENV=development bundle exec thor dradis:reset:password
	if use mysql; then
		einfo "If you want to use a MySQL database check the dradis\
		documentation: http://dradisframework.org/configure.html\#configure"
	fi
}
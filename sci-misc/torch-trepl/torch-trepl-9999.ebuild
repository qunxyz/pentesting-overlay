# Copyright 1999-2017 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2

EAPI=6
inherit git-r3 cmake-utils

DESCRIPTION="A pure Lua-based, lightweight REPL for Torch."
HOMEPAGE="https://github.com/torch/trepl"
EGIT_REPO_URI="https://github.com/torch/trepl.git"

LICENSE="BSD"
SLOT="0"
KEYWORDS="~amd64"
IUSE="luajit cuda cudnn opencl extra gnuplot qt threads"

COMMON_DEPEND="!luajit? ( >=dev-lang/lua-5.1:= )
	luajit? ( dev-lang/luajit:2= )
	virtual/blas
	virtual/lapack
	dev-lua/luafilesystem
	dev-lua/penlight
	dev-lua/lua-cjson
"
DEPEND="${COMMON_DEPEND}
	sys-libs/readline
	sci-libs/torch-xlua
	sci-libs/torch-nngraph
	sci-libs/torch-image
	sci-libs/torch-optim
"
# cuda not tested
RDEPEND="${DEPEND}
	cuda? (
		sci-libs/torch-cutorch
		sci-libs/torch-cunn
	)
	extra? (
		gnuplot? ( sci-libs/torch-gnuplot )
		qt? (
			sci-libs/torch-qttorch
		)
		threads? (
			sci-libs/torch-threads
		)
		sci-libs/torch-argcheck
		sci-libs/torch-nnx
		sci-libs/torch-env
	)
	cudnn? (
		sci-libs/torch-cudnn
	)
"
#
#	opencl? (
#		sci-libs/torch-clnn
#	)
#sci-libs/torch-cltorch
REQUIRED_USE="cudnn? ( cuda )"

src_prepare() {
	local LUA=$(usex luajit 'luajit' 'lua')
	if [[ "${LUA}" == "lua" ]]; then
		sed -i -e 's/luajit/lua/' th
	fi
	eapply_user
}

src_configure() {
	local LUA=$(usex luajit 'luajit' 'lua')
	local INSTALL_BIN=$($(tc-getPKG_CONFIG) --variable INSTALL_BIN ${LUA})
	local INSTALL_INC=$($(tc-getPKG_CONFIG) --variable INSTALL_INC ${LUA}) #/usr/include, *.h
	local INSTALL_LMOD=$($(tc-getPKG_CONFIG) --variable INSTALL_LMOD ${LUA}) #/usr/share/lua, *.lua
	local INSTALL_CMOD=$($(tc-getPKG_CONFIG) --variable INSTALL_CMOD ${LUA}) #/usr/lib/lua, *.so

	local mycmakeargs=(
		"-DLUA_INCDIR=${INSTALL_INC}"
		"-DLUA_LIBDIR=${INSTALL_CMOD}"
		"-DLUA_BINDIR=${INSTALL_BIN}"
		"-DLUA=${LUA}"

		"-DBINDIR=${INSTALL_BIN}"
		"-DLIBDIR=${INSTALL_CMOD}"
		"-DLUADIR=${INSTALL_LMOD}"
	)

	cmake-utils_src_configure
}

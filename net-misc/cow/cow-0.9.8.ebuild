# Copyright 1999-2013 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: app-pda/libplist/libplist-9999.ebuild,v 1.0 2014/01/13 17:21:55 srcs Exp $

EAPI=6
inherit golang-build systemd

DESCRIPTION="HTTP proxy written in Go. COW can automatically identify blocked sites and use parent proxies to access."
HOMEPAGE="https://github.com/cyfdecyf/cow"
SRC_URI="https://github.com/cyfdecyf/cow/archive/${PV}.tar.gz"

LICENSE="GPL-2 LGPL-2.1"
SLOT="0"
KEYWORDS="amd64 ~arm ~ppc ~ppc64 x86"
IUSE="systemd"
DEPEND="dev-lang/go"

pkg_dependencies=(
    "github.com/cyfdecyf/bufio"
    "github.com/cyfdecyf/color"
    "github.com/cyfdecyf/leakybuf"
    "github.com/shadowsocks/shadowsocks-go/shadowsocks"
)

src_compile() {
	for pkg in ${pkg_dependencies[*]}; do
		GOPATH=${WORKDIR} go get "${pkg}"
	done
    GOPATH=${WORKDIR} go build
}

src_install() {
	dobin ${P} 
	dosym /usr/bin/${P} /usr/bin/cow

	if use systemd; then
		systemd_dounit "${FILESDIR}/cow@.service" || die "install failed"
		systemd_dounit "${FILESDIR}/cow_user.service" || die "install failed"
		einfo "If you want cow.service autostart, please enable it"
		einfo "systemctl enable cow@user"
		einfo "To start cow manually, execute:"
		einfo "systemctl --user start cow"
	fi
}

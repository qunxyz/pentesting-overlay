# Copyright 1999-2016 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Id$

EAPI=6

inherit git-r3 multilib toolchain-funcs eutils

DESCRIPTION="FFI package for Lua 5.1 and Lua 5.2."
HOMEPAGE="https://github.com/facebookarchive/luaffifb"

EGIT_REPO_URI="https://github.com/facebookarchive/luaffifb.git"

LICENSE="BSD2"
SLOT="0"
KEYWORDS=""
IUSE="luajit"

DEPEND="dev-lang/lua
"
RDEPEND="${DEPEND}"

BUILD_DIR="${S}/build"

src_prepare() {
	eapply_user
	mkdir -p ${BUILD_DIR}/lib/ffi ${BUILD_DIR}/share/ffi
}

src_compile() {
	local CC="$(tc-getCC)"
	local LUA=$(usex luajit 'luajit' 'lua')
	local INSTALL_LIB=$($(tc-getPKG_CONFIG) --variable INSTALL_LIB $(usex luajit 'luajit' 'lua')) #share, *.lua
	local INSTALL_INC=$($(tc-getPKG_CONFIG) --variable INSTALL_INC $(usex luajit 'luajit' 'lua')) #share, *.lua

	local modules="call ctype ffi parser test"

	emake headers
	for m in ${modules}; do ${CC} -O2 -fPIC -I${INSTALL_INC} -c ${m}.c -o ${m}.o -Idynasm; done

	${CC} -shared -o ${BUILD_DIR}/lib/ffi.so -L${INSTALL_LIB} $(for m in ${modules}; do echo ${m}.o; done)
	${CC} -shared -o ${BUILD_DIR}/lib/ffi/libtest.so -L${INSTALL_LIB} test.o
	cp test.lua ${BUILD_DIR}/share/ffi
}

src_install() {
	local INSTALL_CMOD=$($(tc-getPKG_CONFIG) --variable INSTALL_CMOD $(usex luajit 'luajit' 'lua')) #lib, *.so
	local INSTALL_LMOD=$($(tc-getPKG_CONFIG) --variable INSTALL_LMOD $(usex luajit 'luajit' 'lua')) #share, *.lua

	insinto ${INSTALL_CMOD}
	doins -r ${BUILD_DIR}/lib/*

	insinto ${INSTALL_LMOD}
	doins -r ${BUILD_DIR}/share/*
}

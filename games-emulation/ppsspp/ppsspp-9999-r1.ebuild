# Copyright 1999-2013 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $

EAPI=5

inherit eutils cmake-utils git-r3

DESCRIPTION="A PSP emulator for Android, Windows, Mac, Linux and Blackberry 10, written in C++."
HOMEPAGE="http://www.ppsspp.org/"
EGIT_REPO_URI="git://github.com/hrydgard/ppsspp.git"
SRC_URI="http://www.ppsspp.org/img/ppsspp-icon.png"

LICENSE="GPL-2"
SLOT="0"
KEYWORDS="~amd64 ~x86"
IUSE="+qt5 sdl headless"
REQUIRED_USE="
	headless? ( || ( qt5 sdl ) )
	?? ( qt5 sdl )
"

RDEPEND=""
DEPEND="sys-libs/zlib
	sdl? ( media-libs/libsdl )
	sdl? ( media-libs/libsdl2 )
	sdl? ( dev-util/cmake )
	qt5? (
		dev-db/sqlite
		dev-qt/assistant:5
		dev-qt/qtcore:5
		dev-qt/qtdeclarative:5
		dev-qt/qtgui:5
		dev-qt/qtmultimedia:5
		dev-qt/qtopengl:5
		dev-qt/qtsvg:5
		dev-qt/qtwebkit:5
		dev-qt/qtwidgets:5
	)"

src_unpack() {
	git-r3_fetch
	git-r3_checkout
	#if use qt5 ; then
	#	cd "${WORKDIR}"/"${P}"/Qt
	#	qt4-r2_src_unpack
	#fi
	#cp ${DISTDIR}/ppsspp-icon.png  "${WORKDIR}"/"${P}"/
}

src_prepare() {
	#epatch "$FILESDIR"/ppsspp-cmake.patch
	#epatch "$FILESDIR"/ppsspp-ffmpeg-x86_64.patch
	#epatch "$FILESDIR"/ppsspp-ffmpeg-x86.patch
	#epatch "$FILESDIR"/ppsspp-qt.patch
	#if use qt5 ; then
	#	cd "${WORKDIR}"/"${P}"/Qt
	#	qt4-r2_src_prepare
	#else
	#	cmake-utils_src_prepare
	#fi
	cmake-utils_src_prepare
}

src_configure() {
	local mycmakeargs=(
		-DUSING_QT_UI=$(usex qt5)
		-DUSE_SYSTEM_FFMPEG=ON
		-DHEADLESS=$(usex headless)
		)
	cmake-utils_src_configure
}

src_compile() {
	cmake-utils_src_compile
}

src_install() {
	use headless && dobin "${BUILD_DIR}/PPSSPPHeadless"
	insinto /usr/share/"${PN}"
	doins -r "${BUILD_DIR}/assets"
	if use qt5 || use sdl ; then
		dobin "${BUILD_DIR}/PPSSPP$(usex qt5 Qt SDL)"
		local i
		for i in 16 24 32 48 64 96 128 256 512 ; do
			doicon -s ${i} "icons/hicolor/${i}x${i}/apps/${PN}.png"
		done
		make_desktop_entry "PPSSPP$(usex qt5 Qt SDL)" "PPSSPP ($(usex qt5 Qt SDL))" "${PN}" "Game"
	fi
}
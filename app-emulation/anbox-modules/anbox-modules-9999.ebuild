# Copyright 1999-2017 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2

EAPI=4

inherit git-2 eutils flag-o-matic linux-info linux-mod user versionator udev

DESCRIPTION="Anbox kernel modules"
HOMEPAGE="https://anbox.io/"
EGIT_REPO_URI="https://github.com/anbox/anbox"

LICENSE="GPL-2"
SLOT="0"
KEYWORDS="~amd64"
IUSE=""

RDEPEND="app-emulation/anbox"
DEPEND="${RDEPEND}"

S="${WORKDIR}/kernel"

pkg_setup() {
	linux-mod_pkg_setup
	BUILD_PARAMS="KERN_DIR=${KV_DIR} O=${KV_OUT_DIR} V=1 KBUILD_VERBOSE=1"
}
#src_prepare() {
#	cp "${FILESDIR}/Makefile" .
#}

src_compile() {
	linux-mod_src_compile
}

src_install() {
	#die "test"
	linux-mod_src_install

	local udevrules="${T}/99-anbox.rules"
	cat > "${udevrules}" <<-EOF
		KERNEL=="ashmem", NAME="%k", MODE="0666"
		KERNEL=="binder*", NAME="%k", MODE="0666"
	EOF
	udev_dorules "${udevrules}"

	dodir /etc/modprobe.d/

	cat > "${D}"/etc/modprobe.d/anbox.conf <<-EOF
		ashmem_linux
		binder_linux
	EOF

	export installed_modprobe_conf=1
}

pkg_postinst() {
	linux-mod_pkg_postinst
	if [ "${installed_modprobe_conf}"x == "x"  ] ; then
		if [ -f "${ROOT}/etc/modprobe.d/anbox.conf" ] ; then
			ewarn "Please check the /etc/modprobe.d/anbox.conf file"
		fi
	fi
}
